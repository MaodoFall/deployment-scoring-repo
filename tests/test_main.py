import pytest
from fastapi.testclient import TestClient
from api_rest.main import app  #
import pandas as pd

client = TestClient(app)

# Fixture qui fournit les données pour les tests
@pytest.fixture
def data():
    # Exemple de données que l'API attend
    return {'SK_ID_CURR': {'5062': -1.3671972683},
 'POS_SK_DPD_DEF_SUM': {'5062': -0.0149832621},
 'CC_DRAWING_LIMIT_RATIO_MAX': {'5062': 5.976001684e-16},
 'INSTAL_PAYMENT_RATIO_MEAN': {'5062': -0.0060896235},
 'POS_REMAINING_INSTALMENTS': {'5062': -0.5053055997},
 'CC_LAST_AMT_BALANCE_MEAN': {'5062': 1.923763774e-16},
 'CC_PAYMENT_DIV_MIN_MIN': {'5062': 3.795395499e-17},
 'CC_LATE_PAYMENT_VAR': {'5062': -5.005092245e-16},
 'NEW_DOC_KURT': {'5062': 0.1253459476},
 'PREV_SK_ID_PREV_NUNIQUE': {'5062': -0.7357948989},
 'REFUSED_AMT_GOODS_PRICE_MAX': {'5062': 2.068699857e-16},
 'ORGANIZATION_TYPE_Industry_type_5': {'5062': -0.0446537396},
 'CC_AMT_PAYMENT_TOTAL_CURRENT_SUM': {'5062': 0.0},
 'CC_CNT_DRAWINGS_POS_CURRENT_SUM': {'5062': 0.0},
 'APPROVED_AMT_GOODS_PRICE_MAX': {'5062': -0.7630325993},
 'PREV_NAME_SELLER_INDUSTRY_Connectivity_MEAN': {'5062': 1.0646014269},
 'APPROVED_AMT_ANNUITY_MAX': {'5062': -0.8300897175},
 'BURO_CREDIT_ACTIVE_Active_MEAN': {'5062': -1.4098192067},
 'PREV_NAME_PRODUCT_TYPE_walk_in_MEAN': {'5062': -0.4638905289},
 'BURO_AMT_CREDIT_SUM_MAX': {'5062': -0.2760130472},
 'CC_CNT_DRAWINGS_ATM_CURRENT_SUM': {'5062': 1.08348055e-16},
 'ACTIVE_DAYS_CREDIT_VAR': {'5062': 0.0},
 'ACTIVE_MONTHS_BALANCE_MAX_MAX': {'5062': 1.833130628e-17},
 'NAME_EDUCATION_TYPE_Higher_education': {'5062': -0.5877743064},
 'CC_CNT_DRAWINGS_POS_CURRENT_VAR': {'5062': -1.951668711e-16},
 'PREV_APP_CREDIT_PERC_MIN': {'5062': 0.2178863959},
 'REGION_RATING_CLIENT_W_CITY': {'5062': -0.0244211908},
 'NAME_HOUSING_TYPE_House_apartment': {'5062': 0.3418025174},
 'CLOSED_AMT_CREDIT_SUM_DEBT_SUM': {'5062': -0.0452443126},
 'APPROVED_DAYS_DECISION_MEAN': {'5062': -1.1777660766},
 'ANNUITY_INCOME_PERC': {'5062': -1.0601527331},
 'ORGANIZATION_TYPE_Services': {'5062': -0.0789573273},
 'FLAG_DOCUMENT_8': {'5062': -0.3115239529},
 'ORGANIZATION_TYPE_Cleaning': {'5062': -0.0297142853},
 'ORGANIZATION_TYPE_Military': {'5062': -0.1048458761},
 'ORGANIZATION_TYPE_School': {'5062': -0.1646793458},
 'INSTAL_DPD_MEAN': {'5062': 0.1297032241},
 'INSTAL_DBD_SUM': {'5062': -0.5842926307},
 'DAYS_BIRTH': {'5062': 0.3661898589},
 'INSTAL_DPD_MAX': {'5062': 0.1133285917},
 'ACTIVE_AMT_CREDIT_SUM_DEBT_MAX': {'5062': 9.107931071e-17},
 'OCCUPATION_TYPE_High_skill_tech_staff': {'5062': -0.1988450337},
 'CC_AMT_DRAWINGS_ATM_CURRENT_VAR': {'5062': -1.119997829e-16},
 'ACTIVE_DAYS_CREDIT_ENDDATE_MEAN': {'5062': 0.0},
 'CC_CNT_DRAWINGS_ATM_CURRENT_MIN': {'5062': -9.997221069e-17},
 'PREV_NAME_TYPE_SUITE_Spouse_partner_MEAN': {'5062': -0.3097680754},
 'CC_AMT_DRAWINGS_OTHER_CURRENT_MEAN': {'5062': 3.216107157e-17},
 'POS_SK_DPD_DEF_MEAN': {'5062': -0.0173435763},
 'ACTIVE_DAYS_CREDIT_ENDDATE_MIN': {'5062': 0.0},
 'PREV_AMT_DOWN_PAYMENT_MAX': {'5062': 0.8338343968},
 'BURO_AMT_CREDIT_SUM_SUM': {'5062': -0.475178681},
 'PREV_NAME_TYPE_SUITE_Group_of_people_MEAN': {'5062': -0.0557978547},
 'PREV_APP_CREDIT_PERC_MEAN': {'5062': 3.5960676231},
 'INSTAL_AMT_PAYMENT_MEAN': {'5062': -0.4707659103},
 'ACTIVE_DAYS_CREDIT_UPDATE_MEAN': {'5062': 7.206973126e-17},
 'INSTAL_DAYS_ENTRY_PAYMENT_MAX': {'5062': -0.0701963625},
 'PREV_NAME_TYPE_SUITE_Unaccompanied_MEAN': {'5062': -1.0391044508},
 'CC_CNT_DRAWINGS_POS_CURRENT_MIN': {'5062': 0.0},
 'ACTIVE_AMT_CREDIT_SUM_MEAN': {'5062': 0.0},
 'OCCUPATION_TYPE_Private_service_staff': {'5062': -0.0970692317},
 'CC_CNT_DRAWINGS_OTHER_CURRENT_MEAN': {'5062': -0.0},
 'BURO_AMT_CREDIT_SUM_MEAN': {'5062': -0.2499908208},
 'CC_AMT_DRAWINGS_OTHER_CURRENT_MIN': {'5062': -3.96132206e-18},
 'CC_AMT_DRAWINGS_OTHER_CURRENT_SUM': {'5062': 0.0},
 'INSTAL_AMT_PAYMENT_SUM': {'5062': -0.6338442658},
 'PREV_NAME_PRODUCT_TYPE_nan_MEAN': {'5062': 0.0},
 'CC_CNT_DRAWINGS_ATM_CURRENT_MEAN': {'5062': -1.768002779e-16},
 'OCCUPATION_TYPE_HR_staff': {'5062': -0.0462402194},
 'BURO_AMT_CREDIT_SUM_OVERDUE_MEAN': {'5062': -0.0141568122},
 'PREV_CODE_REJECT_REASON_LIMIT_MEAN': {'5062': -0.2709928212},
 'CC_AMT_DRAWINGS_POS_CURRENT_MIN': {'5062': -2.630377391e-17},
 'BURO_AMT_CREDIT_MAX_OVERDUE_MEAN': {'5062': -9.279571495e-18},
 'FLOORSMAX_MODE': {'5062': -0.9869994746},
 'CODE_GENDER': {'5062': -0.7011745543},
 'INSTAL_DBD_MEAN': {'5062': -0.1630713633},
 'ORGANIZATION_TYPE_Advertising': {'5062': -0.0381931182},
 'EXT_SOURCE_3': {'5062': 1.4799438139},
 'OCCUPATION_TYPE_Managers': {'5062': -0.281288663},
 'FLAG_OWN_REALTY': {'5062': -0.6694881566},
 'POS_COUNT': {'5062': -0.4881321018},
 'AMT_CREDIT': {'5062': -0.7984286265},
 'INCOME_PER_PERSON': {'5062': 0.5897056562},
 'ORGANIZATION_TYPE_Police': {'5062': -0.0955503412},
 'FLAG_WORK_PHONE': {'5062': 1.9710777063},
 'ORGANIZATION_TYPE_University': {'5062': -0.0674873406},
 'ORGANIZATION_TYPE_Medicine': {'5062': -0.1910206801},
 'ORGANIZATION_TYPE_Telecom': {'5062': -0.0441900857},
 'ORGANIZATION_TYPE_Housing': {'5062': -0.0948922195},
 'FLAG_EMAIL': {'5062': -0.4407238976},
 'REGION_POPULATION_RELATIVE': {'5062': 0.0971342801},
 'FLAG_DOCUMENT_13': {'5062': 0.0},
 'FLOORSMAX_MEDI': {'5062': -1.0146461107},
 'ORGANIZATION_TYPE_Electricity': {'5062': -0.0566627682},
 'REGION_RATING_CLIENT': {'5062': -0.0730043523},
 'DAYS_ID_PUBLISH': {'5062': -0.7871777583},
 'TOTALAREA_MODE': {'5062': -0.9015266556},
 'FLAG_DOCUMENT_16': {'5062': 0.0},
 'YEARS_BEGINEXPLUATATION_MODE': {'5062': -0.0433170281},
 'INSTAL_COUNT': {'5062': -0.6351748756},
 'ORGANIZATION_TYPE_Realtor': {'5062': -0.0384615385},
 'FLAG_DOCUMENT_6': {'5062': -0.3096180055},
 'FLAG_DOCUMENT_3': {'5062': 0.520828215},
 'FLOORSMAX_AVG': {'5062': -1.0216754042},
 'OCCUPATION_TYPE_Laborers': {'5062': -0.4646446324},
 'ORGANIZATION_TYPE_Security': {'5062': -0.0988833914},
 'AMT_INCOME_TOTAL': {'5062': 1.0349348882},
 'PAYMENT_RATE': {'5062': 1.4827327161},
 'FLAG_OWN_CAR': {'5062': 1.4022219851},
 'ORGANIZATION_TYPE_Mobile': {'5062': -0.0303980857},
 'INSTAL_DBD_MAX': {'5062': -0.1258894462},
 'DAYS_EMPLOYED_PERC': {'5062': 0.7191476444},
 'INCOME_CREDIT_PERC': {'5062': 1.8882378363},
 'ORGANIZATION_TYPE_Postal': {'5062': -0.0778980838},
 'ORGANIZATION_TYPE_Insurance': {'5062': -0.0405453536},
 'OCCUPATION_TYPE_Accountants': {'5062': -0.1858844213},
 'BURO_CREDIT_TYPE_Microloan_MEAN': {'5062': -0.1372038197},
 'INSTAL_NUM_INSTALMENT_VERSION_NUNIQUE': {'5062': -0.2203258958},
 'INS_24M_AMT_BALANCE_MAX': {'5062': 0.0},
 'ORGANIZATION_TYPE_Agriculture': {'5062': -0.0776310699},
 'CC_AMT_PAYMENT_TOTAL_CURRENT_MIN': {'5062': 5.469858933e-18},
 'CC_CNT_DRAWINGS_OTHER_CURRENT_SUM': {'5062': -6.880853322e-17},
 'PREV_NAME_TYPE_SUITE_Other_B_MEAN': {'5062': -0.1615930934},
 'CC_AMT_DRAWINGS_ATM_CURRENT_MIN': {'5062': 1.304488805e-17},
 'CC_NAME_CONTRACT_STATUS_Sent_proposal_MIN': {'5062': 0.0},
 'FLAG_DOCUMENT_11': {'5062': -0.0342161326},
 'CC_CNT_DRAWINGS_CURRENT_MIN': {'5062': -6.474468708e-17},
 'EXT_SOURCE_2': {'5062': 1.0831512373},
 'AMT_ANNUITY': {'5062': -0.3898412845},
 'BURO_CREDIT_TYPE_Mortgage_MEAN': {'5062': -0.1972832253},
 'AMT_GOODS_PRICE': {'5062': -0.7057144907},
 'APPROVED_CNT_PAYMENT_MEAN': {'5062': -0.7611620885},
 'FLAG_DOCUMENT_18': {'5062': -0.0395170982},
 'ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN': {'5062': -6.961641026e-17},
 'ORGANIZATION_TYPE_Construction': {'5062': -0.1475794283},
 'INSTAL_AMT_PAYMENT_MIN': {'5062': -0.3912242652},
 'BURO_AMT_CREDIT_SUM_DEBT_MEAN': {'5062': -0.308854676}
 }

def test_read_root():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Prédiction de la solvabilité du client"}

def test_predict_client_solvable(data):  # Utilisation de la fixture data
    response = client.post("/predict", json=data)
    assert response.status_code == 200
    prediction = response.json()
    assert "Prédiction" in prediction
    assert prediction["Prédiction"] in ["Client solvable", "Client non solvable"]

